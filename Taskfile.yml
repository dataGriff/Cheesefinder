version: '3'

# Cheesefinder - Development Task Automation
# This Taskfile provides easy commands for development, testing, and deployment

env:
  NODE_ENV: development
  DATABASE_URL: postgres://cheesefinder_user:cheesefinder_password@localhost:5432/cheesefinder_db
  DEV_PORT: 5000
  PROD_PORT: 5001

vars:
  APP_NAME: cheesefinder
  DEV_CONTAINER: cheesefinder-app-dev
  PROD_CONTAINER: cheesefinder-app-prod
  DB_CONTAINER: cheesefinder-db

tasks:
  # === SETUP TASKS ===
  
  setup:
    desc: "ğŸš€ Complete project setup (first time setup)"
    cmds:
      - task: setup:env
      - task: setup:deps
      - task: setup:docker
      - task: db:setup
    silent: false

  setup:env:
    desc: "ğŸ“‹ Setup environment variables"
    cmds:
      - |
        if [ ! -f .env ]; then
          if [ -f .env.example ]; then
            cp .env.example .env
            echo "âœ… Created .env file from .env.example"
          else
            echo "âš ï¸  No .env.example found, creating basic .env"
            cat > .env << EOF
        NODE_ENV=development
        DATABASE_URL=postgres://cheesefinder_user:cheesefinder_password@localhost:5432/cheesefinder_db
        PORT=5000
        SESSION_SECRET=local-dev-session-secret-change-in-production
        REPL_ID=local-dev-client
        ISSUER_URL=https://replit.com/oidc
        DEV_MODE=true
        EOF
          fi
          echo "ğŸ“ Please review and update .env file as needed"
        else
          echo "âœ… .env file already exists"
        fi
    silent: true

  setup:deps:
    desc: "ğŸ“¦ Install dependencies"
    cmds:
      - npm install
      - echo "âœ… Dependencies installed"

  setup:docker:
    desc: "ğŸ³ Setup Docker environment"
    deps: [setup:env]
    cmds:
      - docker-compose pull
      - echo "âœ… Docker images pulled"

  # === DEVELOPMENT TASKS ===

  dev:
    desc: "ğŸ”§ Start development environment (Docker)"
    deps: [docker:up]
    cmds:
      - echo "ğŸŒ Development server starting at http://localhost:{{.DEV_PORT}}"
      - echo "ğŸ“Š Database available at localhost:5432"
      - echo "ğŸ” Use 'task logs' to view application logs"
      - echo "ğŸ›‘ Use 'task stop' to stop all services"

  dev:local:
    desc: "ğŸ”§ Start development server (local Node.js)"
    deps: [setup:deps, db:ensure]
    cmds:
      - npm run dev

  build:
    desc: "ğŸ—ï¸  Build application for production"
    cmds:
      - npm run build
      - echo "âœ… Build completed"

  build:docker:
    desc: "ğŸ³ Build Docker images"
    cmds:
      - docker-compose build
      - echo "âœ… Docker images built"

  # === DOCKER TASKS ===

  docker:up:
    desc: "ğŸ³ Start Docker services"
    cmds:
      - docker-compose up -d --build
      - task: docker:wait-db
      - task: db:migrate

  docker:up:prod:
    desc: "ğŸ³ Start production Docker services"
    cmds:
      - docker-compose --profile production up -d --build
      - task: docker:wait-db
      - task: db:migrate

  docker:down:
    desc: "ğŸ³ Stop Docker services"
    cmds:
      - docker-compose down

  docker:restart:
    desc: "ğŸ”„ Restart Docker services"
    cmds:
      - task: docker:down
      - task: docker:up

  docker:wait-db:
    desc: "â³ Wait for database to be ready"
    cmds:
      - |
        echo "â³ Waiting for database to be ready..."
        for i in {1..30}; do
          if docker-compose exec -T postgres pg_isready -U cheesefinder_user -d cheesefinder_db > /dev/null 2>&1; then
            echo "âœ… Database is ready"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Database failed to start within 30 seconds"
            exit 1
          fi
          sleep 1
        done
    silent: true

  # === DATABASE TASKS ===

  db:setup:
    desc: "ğŸ—„ï¸  Complete database setup"
    cmds:
      - task: db:ensure
      - task: db:migrate

  db:ensure:
    desc: "ğŸ—„ï¸  Ensure database is running"
    cmds:
      - |
        if ! docker ps --format "table {{.Names}}" | grep -q "{{.DB_CONTAINER}}"; then
          echo "ğŸš€ Starting database..."
          docker-compose up -d postgres
          task docker:wait-db
        else
          echo "âœ… Database is already running"
        fi

  db:migrate:
    desc: "ğŸ—„ï¸  Run database migrations"
    cmds:
      - |
        if docker ps --format "table {{.Names}}" | grep -q "{{.DEV_CONTAINER}}"; then
          docker-compose exec -T {{.DEV_CONTAINER}} npm run db:push
        else
          npm run db:push
        fi
      - echo "âœ… Database migrations completed"

  db:reset:
    desc: "ğŸ—„ï¸  Reset database (âš ï¸  DESTRUCTIVE)"
    prompt: "This will delete all data. Are you sure?"
    cmds:
      - docker-compose down -v
      - docker-compose up -d postgres
      - task: docker:wait-db
      - task: db:migrate
      - echo "âœ… Database reset completed"

  db:shell:
    desc: "ğŸ—„ï¸  Connect to database shell"
    cmds:
      - docker-compose exec postgres psql -U cheesefinder_user -d cheesefinder_db

  db:dump:
    desc: "ğŸ—„ï¸  Create database backup"
    cmds:
      - |
        timestamp=$(date +%Y%m%d_%H%M%S)
        docker-compose exec -T postgres pg_dump -U cheesefinder_user cheesefinder_db > "backup_${timestamp}.sql"
        echo "âœ… Database backup created: backup_${timestamp}.sql"

  # === TESTING TASKS ===

  test:
    desc: "ğŸ§ª Run all tests"
    cmds:
      - task: test:types
      - task: test:lint
      - echo "âœ… All tests passed"

  test:types:
    desc: "ğŸ” Run TypeScript type checking"
    cmds:
      - npm run check
      - echo "âœ… TypeScript check passed"

  test:lint:
    desc: "ğŸ” Run linting (placeholder - add your linter)"
    cmds:
      - echo "â„¹ï¸  No linter configured. Consider adding ESLint or Prettier"

  # === UTILITY TASKS ===

  logs:
    desc: "ğŸ“‹ View application logs"
    cmds:
      - docker-compose logs -f {{.DEV_CONTAINER}}

  logs:db:
    desc: "ğŸ“‹ View database logs"
    cmds:
      - docker-compose logs -f {{.DB_CONTAINER}}

  logs:all:
    desc: "ğŸ“‹ View all service logs"
    cmds:
      - docker-compose logs -f

  shell:
    desc: "ğŸš Access application container shell"
    cmds:
      - docker-compose exec {{.DEV_CONTAINER}} bash

  shell:db:
    desc: "ğŸš Access database container shell"
    cmds:
      - docker-compose exec {{.DB_CONTAINER}} bash

  status:
    desc: "ğŸ“Š Show service status"
    cmds:
      - echo "=== Docker Services ==="
      - docker-compose ps
      - echo ""
      - echo "=== Application Health ==="
      - |
        if curl -f http://localhost:{{.DEV_PORT}}/health > /dev/null 2>&1; then
          echo "âœ… Application is healthy"
        else
          echo "âŒ Application is not responding"
        fi
      - echo ""
      - echo "=== Database Health ==="
      - |
        if docker-compose exec -T postgres pg_isready -U cheesefinder_user -d cheesefinder_db > /dev/null 2>&1; then
          echo "âœ… Database is healthy"
        else
          echo "âŒ Database is not responding"
        fi

  clean:
    desc: "ğŸ§¹ Clean up development environment"
    cmds:
      - task: docker:down
      - docker-compose down -v --remove-orphans
      - docker system prune -f
      - echo "âœ… Cleanup completed"

  # === PRODUCTION TASKS ===

  prod:start:
    desc: "ğŸš€ Start production environment"
    cmds:
      - task: docker:up:prod
      - echo "ğŸŒ Production server running at http://localhost:{{.PROD_PORT}}"

  prod:stop:
    desc: "ğŸ›‘ Stop production environment"
    cmds:
      - docker-compose --profile production down

  prod:logs:
    desc: "ğŸ“‹ View production logs"
    cmds:
      - docker-compose logs -f {{.PROD_CONTAINER}}

  # === CONVENIENCE ALIASES ===

  start:
    desc: "ğŸš€ Start development (alias for dev)"
    cmds:
      - task: dev

  stop:
    desc: "ğŸ›‘ Stop all services"
    cmds:
      - task: docker:down

  restart:
    desc: "ğŸ”„ Restart all services"
    cmds:
      - task: docker:restart

  # === HELP AND INFO ===

  info:
    desc: "â„¹ï¸  Show project information"
    cmds:
      - echo "ğŸ§€ Cheesefinder Development Environment"
      - echo "======================================"
      - echo ""
      - echo "ğŸ“‚ Project Structure:"
      - echo "   - client/     - React frontend"
      - echo "   - server/     - Express backend"
      - echo "   - shared/     - Shared TypeScript types"
      - echo ""
      - echo "ğŸ”§ Key Technologies:"
      - echo "   - Frontend - React + TypeScript + Vite + Tailwind"
      - echo "   - Backend - Express + TypeScript"
      - echo "   - Database - PostgreSQL + Drizzle ORM"
      - echo "   - Container - Docker + Docker Compose"
      - echo ""
      - echo "ğŸŒ Development URLs:"
      - echo "   - Application - http://localhost:$DEV_PORT"
      - echo "   - Database - localhost:5432"
      - echo ""
      - echo "ğŸ“ Common Commands:"
      - echo "   task setup     - Complete first-time setup"
      - echo "   task dev       - Start development environment"
      - echo "   task logs      - View application logs"
      - echo "   task db:shell  - Connect to database"
      - echo "   task status    - Check service health"
      - echo "   task stop      - Stop all services"
      - echo ""
      - echo "ğŸ“š For more commands, run - task --list"

  default:
    desc: "Show available tasks"
    cmds:
      - task: info
      - echo ""
      - task --list